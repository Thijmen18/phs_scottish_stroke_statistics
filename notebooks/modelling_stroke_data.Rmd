---
title: "R Notebook"
output: html_notebook
---

# PHS Scottish Stroke Statistics

This notebook contains steps to create a predictive multivariate model to predict 
future stroke incidence rates using future population predictions per year
as published by NRS (National Records Scotland)

```{r}
library(tidyverse)
library(GGally)
library(janitor)
library(modelr)
library(broom)

activity_hb <- read_csv("../clean_data/stroke_activity_healthboard.csv")
```

## Joining

Next step: join the population estimates to the activity_hb dataset.

```{r}
pop_est <- read_csv("../clean_data/pop_est_nhs_format.csv")
```
```{r}
# in activity_hb change financial year into regular year
# since its mid-year population estimates, this does not matter for the join

activity_hb_reduced <- activity_hb %>% 
  mutate(year = as.numeric(str_sub(financial_year, start = 1, end = 4), .before = financial_year)) %>% 
  select(year, hbr, admission_type, age_group, sex, diagnosis, number_of_discharges, crude_rate, easr)
```

```{r}
# Healthboard numbers in population estimate dataset are mixed of old and new numbers
# recode so all are new codes

pop_est_hb <- pop_est %>% 
  mutate(hbr = recode(hbr,
                     "S08000001" = "S08000015",
                     "S08000002" = "S08000016",
                     "S08000003" = "S08000017",
                     "S08000004" = "S08000029",
                     "S08000005" = "S08000019",
                     "S08000006" = "S08000020",
                     "S08000007" = "S08000031",
                     "S08000008" = "S08000022",
                     "S08000009" = "S08000032",
                     "S08000010" = "S08000024",
                     "S08000011" = "S08000025",
                     "S08000012" = "S08000026",
                     "S08000013" = "S08000030",
                     "S08000014" = "S08000028"))
```

Join!
```{r}
# join
activity_popest_hb <- activity_hb_reduced %>% 
  left_join(pop_est_hb, by = c("hbr" = "hbr", "sex" = "sex", "year" = "year", "age_group" = "age_group")) %>% 
  select(!"...1")

activity_popest_hb
```

## further data wrangling

```{r}
#check for NAs, and drop the missing number of discharges missing 
# (these are removed by NHS due to confidentiality reasons)
# there are also missing population_size numbers since, 
# not all age_groups exist in my dataset

activity_popest_clean <- activity_popest_hb %>% 
  drop_na("number_of_discharges") %>% 
  drop_na("population_size") 
```

Secondly, there are multiple diagnosis types and admission types that are subdivided 
in multiple categories. I am only interested in the total in admission_type this is
categorised under "all" and for diagnosis this is categorised under Cerebrovascular disease

```{r}
activity_popest_clean <- activity_popest_clean %>% 
  filter(admission_type == "All") %>% 
  filter(diagnosis == "Cerebrovascular Disease")

activity_popest_clean %>% 
  distinct(diagnosis)
```

## Step 1: look at relationships between variables and Crude_rate/ number_of_discharges

```{r}
# How is crude_rate distributed?

activity_popest_clean %>% 
  ggplot() +
  aes(x = year, y = crude_rate/100000) +
  geom_point()

# so it runs from 0 to almost 6%
```

```{r message = FALSE}
# first check the relationships between variables and the crude_rate 

set_1 <- activity_popest_clean %>% 
  select(crude_rate, year, hbr, age_group, sex, number_of_discharges)

set_2 <- activity_popest_clean %>% 
  select(crude_rate, admission_type, diagnosis, easr, population_size)

ggpairs(set_1)
ggpairs(set_2)
# variables of interest: hbr, age_group and sex (but not so obvious from the ggpairs plot)?
# definitely interaction between those!
```

## Step 2: convert character columns to factor

```{r}
# change crude_rate into proportion (/1000)
activity_popest_red <- activity_popest_clean %>% 
  mutate(crude_prop = crude_rate/100000, .before = hbr) %>% 
# select only columns of interest
  select(year, crude_prop, hbr, age_group, sex, number_of_discharges, 
         crude_rate, easr, area_name, population_size) %>% 
  mutate(year = as.factor(year),
         hbr = as.factor(hbr),
         sex = as.factor(sex),
         area_name = as.factor(area_name),
         age_group = as.factor(age_group))
  
```

## step 3: divide into test and train dataset

```{r}
n_data <- nrow(activity_popest_red)


test_index <- sample(1:n_data, size = n_data*0.2)

test_data <- slice(activity_popest_red, test_index)
train_data <- slice(activity_popest_red, -test_index)


# checking proportions in all datasets:
activity_popest_red %>% 
  janitor::tabyl(hbr)

train_data %>% 
  janitor::tabyl(sex)

test_data %>% 
  janitor::tabyl(sex)

# not all that far off, we are good to go.
```

## step 4: modelling

```{r}
# model with single predictor (age_group)
model1 <- glm(crude_prop ~ age_group, data = train_data, family = binomial(link = 'logit'))

# model with single pred (sex)
model2 <- glm(crude_prop ~ sex, data = train_data, family = binomial(link = 'logit'))

#model with single pred (hbr)
model3 <- glm(crude_prop ~ hbr, data = train_data, family = binomial(link = 'logit'))

#model with single pred (population)
model4 <- glm(crude_prop ~ population_size, data = train_data, family = binomial(link = 'logit'))

clean_names(tidy(model1))
clean_names(tidy(model2))
clean_names(tidy(model3))
clean_names(tidy(model4))
```


```{r}
# linear model
model1A <- lm(number_of_discharges ~ age_group, data = train_data)

model2A <- lm(number_of_discharges ~ sex, data = train_data)

model3A <- lm(number_of_discharges ~ hbr, data = train_data)

model4A <- lm(number_of_discharges ~ population_size, data = train_data)

summary(model1A)
summary(model2A)
```

```{r}
colnames(activity_popest_red)
```





```{r}
activity_popest_red
```

